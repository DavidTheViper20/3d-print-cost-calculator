<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Cost Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
           /* box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1); */
           background: #f9f9f9;
            display: flex;
            justify-content: space-between;
        }
        h1 {
            text-align: center;
            width: 100%;
        }
        .input-container {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }
        label {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            margin-top: 5px;
            box-sizing: border-box;
        }
        .result {
            margin-top: 20px;
            font-size: 1.2em;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
        }
        .result p {
            margin: 5px 0;
        }
        #uploadStatus {
            font-style: italic;
            margin-top: 10px;
            color: #333;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .print-time-section {
            margin-top: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
        }
        .print-time-section p {
            margin: 5px 0;
        }
        .total-cost {
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            margin-top: 30px;
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
        }
        .settings {
            display: none;
            width: 45%;
            background: #f2f2f2;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            margin-left: 20px; 
             
        }
        .settings h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .settings input {
            margin-top: 10px;
        }
        .settings .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .material-option {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            border: 2px solid transparent;
        }
        .material-option.selected {
            border: 2px solid black;
        }
        .material-option.black.selected {
            border: 2px solid rgb(122, 122, 122);
        }
        .material-option:hover {
            background-color: #bbb;
        }
        .material-option.white {
            color: black;
        }
        .material-option.black {
            color: white;
        }
        .input-container label {
            margin-top: 15px;
        }
        /* Colour Selector Adjustments */
        .material-option.red { background-color: #f44336; }
        .material-option.orange { background-color: #ff9800; }
        .material-option.yellow { background-color: #ffeb3b; }
        .material-option.green { background-color: #4caf50; }
        .material-option.blue { background-color: #2196f3; }
        .material-option.indigo { background-color: #3f51b5; }
        .material-option.violet { background-color: #9c27b0; }
        .material-option.white { background-color: #ffffff; color: black; }
        .material-option.black { background-color: #000000; color: white; }

        /* New styles to position Quantity */
        .quantity-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            width: 20%;
            margin-left: 10px;
        }
        .quantity-container label {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <div class="page-width">
        <div class="print-calculator" style="padding: 2rem; background-color: #f8f9fa; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); font-family: 'Avenir Next', sans-serif;">
          <div class="left-container"> 
            <h1 style="color: #49220D; font-family: Avenir Next ; font-weight: 400; font-size: 2.5rem;">
              Custom 3D Prints
            </h1>
            
            <div id="file-upload-container" style="display: flex; align-items: center; width: 100%;">
              <div style="flex: 1;">
                <input type="file" id="fileInput" />
                <p id="uploadStatus"></p>
              </div>
            </div>
      
            <!-- Material Type Selector -->
            <div class="input-container">
              <label for="materialType">Material Type:</label>
              <div class="checkbox-container">
                <div class="material-option selected" id="PLA" onclick="selectMaterial('PLA')">PLA</div>
                <div class="material-option" id="ABS" onclick="selectMaterial('ABS')">ABS</div>
                <div class="material-option" id="PETG" onclick="selectMaterial('PETG')">PETG</div>
                <div class="material-option" id="TPU" onclick="selectMaterial('TPU')">TPU</div>
                <div class="material-option" id="Resin" onclick="selectMaterial('Resin')">Resin</div>
              </div>
            </div>
      
            <!-- Colour Selector -->
            <div class="input-container">
              <label for="materialColours">Material Colours:</label>
              <div class="checkbox-container">
                <div class="material-option red" id="Red" onclick="selectColour('Red')">Red</div>
                <div class="material-option orange" id="Orange" onclick="selectColour('Orange')">Orange</div>
                <div class="material-option yellow" id="Yellow" onclick="selectColour('Yellow')">Yellow</div>
                <div class="material-option green" id="Green" onclick="selectColour('Green')">Green</div>
                <div class="material-option blue" id="Blue" onclick="selectColour('Blue')">Blue</div>
                <div class="material-option indigo" id="Indigo" onclick="selectColour('Indigo')">Indigo</div>
                <div class="material-option violet" id="Violet" onclick="selectColour('Violet')">Violet</div>
                <div class="material-option white" id="White" onclick="selectColour('White')">White</div>
                <div class="material-option black" id="Black" onclick="selectColour('Black')">Black</div>
              </div>
            </div>
      
            <!-- Infill Density -->
            <div class="input-container">
              <label for="infill">Infill Density: <span id="infillValue">20</span>%</label>
              <input type="range" id="infill" min="0" max="100" value="20" oninput="updateInfillValue()">
            </div>
      
            <!-- Shell Options -->
            <div id="shell-options-container" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; width: 100%; margin-top: 10px;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <label for="wallLayers">Wall Layers:</label>
                <input type="number" id="wallLayers" value="3" min="1" step="1" style="width: 70px;" />
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <label for="topBottomLayers">Top/Bottom Layers:</label>
                <input type="number" id="topBottomLayers" value="2" min="1" step="1" style="width: 70px;" />
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <label for="layerHeight">Layer Height (mm):</label>
                <input type="number" id="layerHeight" value="0.2" min="0.05" step="0.05" style="width: 70px;" />
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" value="1" min="1" step="1" style="width: 70px;" />
              </div>
            </div>
      
            <!-- Calculate Button -->
            <button onclick="calculateCost()" style="padding: 10px 20px; background-color: blue; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">
              Calculate Cost
            </button>
      
            <!-- Notes Section -->
            <div class="input-container">
              <label for="notes">Notes:</label>
              <textarea id="notes" rows="12" placeholder="Add any additional notes here..." style="width: 96.4%; padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ddd; resize: none;"></textarea>
            </div>
      
            <!-- Total Cost -->
            <div class="total-cost">
              <p><strong>Total Cost:</strong> $<span id="finalTotalCost">0.00</span></p>
              
          </div>
      
          <!-- Settings Box -->
          <div class="settings">
            <h2>Master Settings</h2>
      
            <div class="input-container">
              <label for="pricePerGram">Price per Gram ($):</label>
              <input type="number" id="pricePerGram" value="0.15" step="0.01" onchange="calculateCost()">
            </div>
            <div class="input-container">
              <label for="pricePerHour">Price per Hour ($):</label>
              <input type="number" id="pricePerHour" value="5" step="0.1" onchange="calculateCost()">
            </div>
            <div class="input-container">
              <label for="printSpeed">Printer Speed (mm/s):</label>
              <input type="number" id="printSpeed" value="120" min="10" max="200" onchange="calculateCost()">
            </div>
            <div class="input-container">
              <label for="lineWidth">Line Width (mm):</label>
              <input type="number" id="lineWidth" value="0.2" step="0.05" min="0.2" max="1" onchange="calculateCost()">
            </div>
      
            <!-- Cost Breakdown -->
            <div class="result">
              <p><strong>Volume:</strong> <span id="volume">0</span> mm³</p>
              <p><strong>Weight:</strong> <span id="weight">0.00</span> g</p>
              <p><strong>Material Cost:</strong> $<span id="materialCost">0.00</span></p>
              <p><strong>Time Cost:</strong> $<span id="timeCost">0.00</span></p>
              <p><strong>Total Cost:</strong> $<span id="totalCost">0.00</span></p>
            </div>
      
            <!-- Discount -->
            <div id="DiscountPercentage" style="padding-top: 20px;">
              <div>
                <label for="discountPercentage">Discount per Quantity (%):</label>
                <input type="number" id="discountPercentage" value="5" step="1" min="0" />
              </div>
            </div>
      
            <!-- Additional Fees -->
            <div id="AdditionalFees" style="padding-top: 20px;">
              <div>
                <label for="additionalFees">Flat Additional Fee ($):</label>
                <input type="number" id="additionalFees" value="5" step="0.01" min="0" />
              </div>
            </div>
      
            <!-- Influenced Weight -->
            <div class="result">
              <p><strong>Influenced Weight:</strong> <span id="infillWeight">0.00</span> g</p>
            </div>
      
            <!-- Print Time Info -->
            <div class="print-time-section">
              <p><strong>Print Time:</strong> <span id="printTime">0.00</span> hours</p>
              <p><small>Note: Print time is based on a nozzle size of 0.4mm and a print speed of 120mm/s.</small></p>
            </div>
          </div>
        </div>
      </div>

      <script>
        let volumeMm3 = 0;  
        let weightG = 0;  
        let printSpeed = 120;  
        const nozzleSize = 0.4;  
        let selectedMaterial = "PLA";  // Default material
    
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('uploadStatus').textContent = `Uploading ${file.name}...`;
    
                let formData = new FormData();
                formData.append("file", file);
    
                fetch('/upload', { method: "POST", body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert("Error: " + data.error);
                        } else {
                            if (data.volumeMm3) {
                                volumeMm3 = data.volumeMm3;
                                weightG = calculateWeight(volumeMm3);
                                document.getElementById("volume").textContent = volumeMm3;
                                document.getElementById("weight").textContent = weightG.toFixed(2);
                            } else {
                                console.error('No volume data returned.');
                            }
                            document.getElementById("uploadStatus").textContent = `Uploaded: ${file.name}`;
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
            }
        });
    
        function selectColour(colour) {
            const colourOptions = document.querySelectorAll('.material-option.red, .material-option.orange, .material-option.yellow, .material-option.green, .material-option.blue, .material-option.indigo, .material-option.violet, .material-option.white, .material-option.black');
            colourOptions.forEach(option => option.classList.remove('selected'));
            document.getElementById(colour).classList.add('selected');
        }
    
        function selectMaterial(material) {
            const materialOptions = document.querySelectorAll('#PLA, #ABS, #PETG, #TPU, #Resin');
            materialOptions.forEach(option => option.classList.remove('selected'));
            document.getElementById(material).classList.add('selected');
    
            selectedMaterial = material;
    
            let pricePerGram;
            if (material === "ABS") {
                pricePerGram = 0.12;
            } else if (material === "PETG") {
                pricePerGram = 0.135;
            } else if (material === "TPU") {
                pricePerGram = 0.23;
            } else if (material === "Resin") {
                pricePerGram = 0.19;
            } else {
                pricePerGram = 0.15;  // PLA default
            }
    
            document.getElementById('pricePerGram').value = pricePerGram.toFixed(2);
        }
    
        function calculateWeight(volumeMm3) {
            const materialDensity = 1.24;
            return (volumeMm3 * materialDensity) / 1000;
        }
    
        function calculateInfluencedWeight() {
            const infillDensity = parseFloat(document.getElementById("infill").value) / 100;
            const wallLayers = parseInt(document.getElementById("wallLayers").value);
            const topBottomLayers = parseInt(document.getElementById("topBottomLayers").value);
    
            const shellVolume = volumeMm3 * ((wallLayers + topBottomLayers) / 10);
            let influencedVolume = shellVolume + ((volumeMm3 - shellVolume) * infillDensity);
            let influencedWeight = Math.min((influencedVolume * weightG) / volumeMm3, weightG);
    
            document.getElementById("infillWeight").textContent = influencedWeight.toFixed(2);
            enforceMaxWeightRestriction(influencedWeight);
    
            return influencedWeight;
        }
    
        function enforceMaxWeightRestriction(influencedWeight) {
            if (influencedWeight >= weightG) {
                document.getElementById("wallLayers").setAttribute("max", document.getElementById("wallLayers").value);
                document.getElementById("topBottomLayers").setAttribute("max", document.getElementById("topBottomLayers").value);
            } else {
                document.getElementById("wallLayers").removeAttribute("max");
                document.getElementById("topBottomLayers").removeAttribute("max");
            }
        }
    
        function calculatePrintTime(influencedWeight) {
            const layerHeight = parseFloat(document.getElementById("layerHeight").value);
            const lineWidth = parseFloat(document.getElementById("lineWidth").value);
    
            const influencedVolume = (influencedWeight / weightG) * volumeMm3; 
            const printTimeSeconds = influencedVolume / (printSpeed * layerHeight * lineWidth);
            const printTimeMinutes = printTimeSeconds / 60;
            const hours = Math.floor(printTimeMinutes / 60);
            const minutes = Math.round(printTimeMinutes % 60);
    
            document.getElementById("printTime").textContent = `${hours} hours ${minutes} minutes`;
            return printTimeMinutes / 60;
        }
    
        function calculateCost() {
            const influencedWeight = calculateInfluencedWeight();
            const pricePerGram = parseFloat(document.getElementById("pricePerGram").value);
            const pricePerHour = parseFloat(document.getElementById("pricePerHour").value);
            printSpeed = parseFloat(document.getElementById("printSpeed").value);
            const quantity = parseInt(document.getElementById("quantity").value) || 1;
    
            // Get the discount percentage from the input field
            let discountPercentage = parseFloat(document.getElementById("discountPercentage").value) || 0;
    
            // Calculate the discount based on quantity
            let discount = 0;
            if (quantity > 1) {
                discount = (quantity - 1) * discountPercentage; // Apply the discount percentage per extra item
            }
    
            // Cap the discount at 25%
            if (discount > 25) {
                discount = 25;
            }

             // additional fees
        const additionalFees = parseFloat(document.getElementById("additionalFees").value) || 0;
    
            // Calculate the influenced weight based on quantity
            const adjustedWeight = influencedWeight * quantity;
    
            const materialCost = adjustedWeight * pricePerGram;
            const timeHours = calculatePrintTime(adjustedWeight);
            const timeCost = timeHours * pricePerHour;
    
            // Apply the discount to the total cost
            const totalCost = ((materialCost + timeCost) * (1 - (discount / 100)) + additionalFees);
    
            document.getElementById("materialCost").textContent = materialCost.toFixed(2);
            document.getElementById("timeCost").textContent = timeCost.toFixed(2);
            document.getElementById("totalCost").textContent = totalCost.toFixed(2);
            document.getElementById("finalTotalCost").textContent = totalCost.toFixed(2);
        }
    
        // Recalculate whenever quantity changes
        document.getElementById("quantity").addEventListener("input", calculateCost);
    
        function updateInfillValue() {
            document.getElementById("infillValue").textContent = document.getElementById("infill").value;
            calculateCost();
        }

    </script>
</body>
</html>
